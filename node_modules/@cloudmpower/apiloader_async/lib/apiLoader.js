(function(){

    let _ = require("lodash");

    let getMethod = require("../../../../nodedb/config/getGlobalMethod");

    let methodName = getMethod.FileName;

    module.exports = function(router , route){

        for(let i = 0; i < route.length; i++){
            router[route[i].method](route[i].path, async (ctx, next) => {
                let incomingUrl = ctx.url;
                for(let key in ctx.params){
                    incomingUrl = incomingUrl.replace(ctx.params[key], ":" + key);
                }
                let routeConfig = _.find(route , {path: incomingUrl});
                let moduler = getMethod(methodName[routeConfig.module]);
                let responseHandler = getMethod(methodName.responseHandler);

                ctx.tnxId = ctx.header["x-request-id"] || "";
                ctx.utils = getMethod(methodName.utils);

                let upgradedConsole = getMethod(methodName.consoleUpgrade);
                upgradedConsole(ctx, ctx.config);
                let commandObj = { "body": ctx.request.body, "params": ctx.params, "serviceFrom": ctx.header["x-service-from"] || "", "tnxId": ctx.tnxId, "utils": ctx.utils, "config": ctx.config, "io": ctx.io || {} };

                let contentType = (ctx.header["content-type"]).split(";");
                let contentErrorResponse = {"status": 415 ,"responseData": {"message": "Unsupported Media Type"}};
                if(routeConfig.contentType && routeConfig.contentType != "" && routeConfig.contentType != contentType[0]) return await responseHandler.sendResponse(ctx, contentErrorResponse);

                let session = getMethod(methodName.session)(ctx);
                if(routeConfig.inSession){
                    let sessionExec = await session.validateSession();
                    if(sessionExec.status != 200) return await responseHandler.sendResponse(ctx, sessionExec);
                }

                commandObj.callSessionCreate = session.addToSession;
                commandObj.callSessionUpdate = session.updateToSession;
                commandObj.callSessionRemove = session.removeSession;
                commandObj.addToSession = ctx.addToSession;
                commandObj.removeSession = ctx.removeSession;
                commandObj.checkSession = ctx.checkSession;

                let result = await moduler[routeConfig.handler](commandObj);
                await responseHandler.sendResponse(ctx, result);
            });
        }
    };
})();